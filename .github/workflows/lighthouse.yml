name: Lighthouse

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  audit:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build
        run: npm run build

      - name: Run Lighthouse
        id: lighthouse
        run: node scripts/lighthouse.mjs --json lighthouse-results.json
        continue-on-error: true

      - name: Generate summary
        if: always() && steps.lighthouse.outcome != 'cancelled'
        run: |
          node <<'SCRIPT'
          const fs = require("fs");

          const { threshold, results } = JSON.parse(
            fs.readFileSync("lighthouse-results.json", "utf8"),
          );

          const categories = Object.keys(results[0].scores);

          const icon = (score) => {
            if (score >= 90) return "\u{1F7E2}";
            if (score >= 50) return "\u{1F7E0}";
            return "\u{1F534}";
          };

          const formatName = (key) =>
            key
              .split("-")
              .map((w) => w[0].toUpperCase() + w.slice(1))
              .join(" ");

          const allPassed = results.every((r) =>
            Object.values(r.scores).every((s) => s >= threshold),
          );

          const lines = [];

          lines.push(
            `## ${allPassed ? "\u2705" : "\u26A0\uFE0F"} Lighthouse Results`,
          );
          lines.push("");
          lines.push(
            `| Page | ${categories.map(formatName).join(" | ")} |`,
          );
          lines.push(
            `| --- | ${categories.map(() => "---").join(" | ")} |`,
          );

          for (const r of results) {
            const cells = categories.map((c) => {
              const score = r.scores[c];
              return `${icon(score)} ${score}`;
            });
            lines.push(`| ${r.name} | ${cells.join(" | ")} |`);
          }

          lines.push("");
          lines.push(`> Threshold: **${threshold}**`);

          const summary = lines.join("\n");
          fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary);
          console.log(summary);
          SCRIPT

      - name: Fail if below threshold
        if: steps.lighthouse.outcome == 'failure'
        run: exit 1
