---
import type { GetStaticPaths } from "astro";
import { getCollection } from "astro:content";
import type { BlogType } from "../../../content.config";
import BaseLayout from "../../../layouts/BaseLayout.astro";
import PostCard from "../../../components/PostCard.astro";
import Pagination from "../../../components/Pagination.astro";
import { formatDate } from "../../../utils/formatDate";
import { SITE_TITLE, SITE_AUTHOR } from "../../../consts";
import Year from "../../../components/Year.astro";

export const getStaticPaths = (async ({ paginate }) => {
  const blogs: BlogType[] = await getCollection("blogs");
  const years = [
    ...new Set(blogs.map((blog) => new Date(blog.data.date).getFullYear())),
  ];

  return years.flatMap((year) => {
    const filteredBlogs = blogs
      .filter((blog) => new Date(blog.data.date).getFullYear() === Number(year))
      .sort(
        (a, b) =>
          new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
      );

    return paginate(filteredBlogs, {
      params: { year },
      pageSize: 8,
      props: { years },
    });
  });
}) satisfies GetStaticPaths;

const { page, years } = Astro.props as { page: { data: BlogType[] }; years: number[] };
const { year } = Astro.params as { year: string };
---

<BaseLayout
  title={`Archive ${year} | ${SITE_TITLE}`}
  description={`Blog posts from ${year}`}
  author={SITE_AUTHOR}
  url={`/archive/${year}`}
>
  <section class="center">
    <h1 class="heading">Archive</h1>
    <Year years={years} />
    <div class="space-y-1">
      {
        page.data.map((blog: BlogType) => {
          return (
            <PostCard
              title={blog.data.title}
              date={formatDate(blog.data.date)}
              url={blog.data.slug}
              tags={blog.data.tags}
              cover={blog.data.cover}
            />
          );
        })
      }
    </div>
    <Pagination page={page} />
  </section>
</BaseLayout>
